variables:
  VERSION: dev-0.4.0

stages:
  - build

build:
  stage: build
  tags: [kubernetes]
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    # Tell docker CLI to use the docker daemon started by the service
    DOCKER_HOST: tcp://docker:2375
    # Disable TLS since we're using an internal connection
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    # Pass registry credentials to Docker
    DOCKER_AUTH_CONFIG: '{"auths":{"${HARBOR_URL}":{"username":"${HARBOR_USERNAME}","password":"${HARBOR_PASSWORD}"}}}'
  script:
    - |
      # Install git and ssh
      apk add --no-cache git openssh-client bash shadow

      # Set up SSH for GitHub access
      mkdir -p ~/.ssh
      chmod 700 ~/.ssh

      # Configure SSH to not verify host keys
      cat > ~/.ssh/config << EOF
      Host github.com
        StrictHostKeyChecking no
        UserKnownHostsFile=/dev/null

      Host git.bemade.org
        StrictHostKeyChecking no
        UserKnownHostsFile=/dev/null
      EOF
      chmod 600 ~/.ssh/config

      # Add the SSH key - copy from the CI/CD variable
      cp "$SSH_KEY_GITHUB" ~/.ssh/github_key
      chmod 600 ~/.ssh/github_key
      eval $(ssh-agent -s)
      ssh-add ~/.ssh/github_key

      # Login to Docker registry
      echo "${HARBOR_PASSWORD}" | docker login ${HARBOR_URL} -u "${HARBOR_USERNAME}" --password-stdin

      docker build -t docker.bemade.org/bemade/odoo-operator:$VERSION -t docker.bemade.org/bemade/odoo-operator:latest .
      docker push docker.bemade.org/bemade/odoo-operator:latest
      docker push docker.bemade.org/bemade/odoo-operator:$VERSION
