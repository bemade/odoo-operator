apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: odooinstances.bemade.org
  annotations:
    helm.sh/resource-policy: keep
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/{{ .Release.Name }}-webhook-cert
spec:
  group: bemade.org
  names:
    kind: OdooInstance
    listKind: OdooInstanceList
    plural: odooinstances
    singular: odooinstance
    shortNames:
      - odoo
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: false
      deprecated: true
      deprecationWarning: "v1alpha1 is deprecated, please use v1alpha2"
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - image
                - ingress
                - replicas
                - adminPassword
              properties:
                image:
                  type: string
                  description: "Odoo Docker image to use."
                  default: "odoo:18.0"
                imagePullSecret:
                  type: string
                  description: "Image pull secret to use."
                adminPassword:
                  type: string
                  description: "Odoo database administrator password to use."
                replicas:
                  type: integer
                  minimum: 1
                  default: 1
                  description: "Number of Odoo replicas"
                resources:
                  type: object
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: 200m
                        memory:
                          type: string
                          default: 250Mi
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: 2000m
                        memory:
                          type: string
                          default: 2Gi
                filestore:
                  type: object
                  properties:
                    storageSize:
                      type: string
                      default: "2Gi"
                    storageClass:
                      type: string
                      default: standard
                ingress:
                  type: object
                  required:
                    - hosts
                    - issuer
                  properties:
                    hosts:
                      type: array
                      items:
                        type: string
                      description: "The fully qualified domain names (FQDN) for this host."
                    issuer:
                      type: string
                      description: "The name of the ClusterIssuer to user to issue the TLS certificate."
                    class:
                      type: string
                      description: "The ingress class to use."
                      default: null
                configOptions:
                  type: object
                  description: "Options for the odoo.conf file"
                  additionalProperties:
                    type: string
                  example:
                    workers: "2"
                    limit_time_real: "0"
                    limit_time_cpu: "0"
                database:
                  type: object
                  description: "Database configuration for this instance"
                  properties:
                    cluster:
                      type: string
                      description: "Name of the PostgreSQL cluster from the postgres-clusters secret. If not specified, uses the cluster marked as default."
                # NOTE: Database initialization/restore handled via OdooRestoreJob CRD
                # NOTE: Upgrades handled via OdooUpgradeJob CRD
                strategy:
                  type: object
                  description: "Deployment strategy configuration"
                  properties:
                    type:
                      type: string
                      enum: ["Recreate", "RollingUpdate"]
                      default: "Recreate"
                      description: "Deployment strategy type"
                    rollingUpdate:
                      type: object
                      description: "RollingUpdate configuration parameters"
                      properties:
                        maxUnavailable:
                          type: string
                          default: "25%"
                          description: "Maximum number of unavailable pods during update"
                        maxSurge:
                          type: string
                          default: "25%"
                          description: "Maximum number of additional pods that can be created during update"
                sync:
                  type: object
                  description: "Configuration for Git repository synchronization (uses gitProject for repository details)"
                  properties:
                    enabled:
                      type: boolean
                      description: "When set to true, triggers a sync operation. Resets to false after sync completes."
                      default: false
                    time:
                      type: string
                      description: "The scheduled time for sync. Format: YYYY-MM-DDTHH:MM:SSZ."
                      format: date-time
                # NOTE: spec.restore has been moved to OdooRestoreJob CRD
                # Use OdooRestoreJob CR to trigger restore operations
                webhook:
                  type: object
                  description: "Webhook configuration for status update notifications"
                  properties:
                    url:
                      type: string
                      description: "URL to POST status updates to when instance phase changes"
                probes:
                  type: object
                  description: "Health check probe configuration for Kubernetes"
                  properties:
                    startupPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for startup probe. Used during container initialization."
                    livenessPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for liveness probe. Checks if the process is alive."
                    readinessPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for readiness probe. Use /health/ready if health_check_k8s module is installed for deep checks (DB + filestore)."

            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Running
                    - Upgrading
                    - Restoring
                  default: Running
                message:
                  type: string
                ready:
                  type: boolean
                url:
                  type: string
                lastBackup:
                  type: string
                  format: date-time
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: URL
          type: string
          jsonPath: .status.url
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}

    - name: v1alpha2
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - image
                - ingress
                - replicas
                - adminPassword
              properties:
                image:
                  type: string
                  description: "Odoo Docker image to use."
                  default: "odoo:18.0"
                imagePullSecret:
                  type: string
                  description: "Image pull secret to use."
                adminPassword:
                  type: string
                  description: "Odoo database administrator password to use."
                replicas:
                  type: integer
                  minimum: 1
                  default: 1
                  description: "Number of Odoo replicas"
                resources:
                  type: object
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: 200m
                        memory:
                          type: string
                          default: 250Mi
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: 2000m
                        memory:
                          type: string
                          default: 2Gi
                filestore:
                  type: object
                  properties:
                    storageSize:
                      type: string
                      default: "2Gi"
                    storageClass:
                      type: string
                      default: standard
                ingress:
                  type: object
                  required:
                    - hosts
                    - issuer
                  properties:
                    hosts:
                      type: array
                      items:
                        type: string
                      description: "The fully qualified domain names (FQDN) for this host."
                    issuer:
                      type: string
                      description: "The name of the ClusterIssuer to user to issue the TLS certificate."
                    class:
                      type: string
                      description: "The ingress class to use."
                      default: null
                configOptions:
                  type: object
                  description: "Options for the odoo.conf file"
                  additionalProperties:
                    type: string
                  example:
                    workers: "2"
                    limit_time_real: "0"
                    limit_time_cpu: "0"
                database:
                  type: object
                  description: "Database configuration for this instance"
                  properties:
                    cluster:
                      type: string
                      description: "Name of the PostgreSQL cluster from the postgres-clusters secret. If not specified, uses the cluster marked as default."
                # NOTE: Database initialization/restore handled via OdooRestoreJob CRD
                # NOTE: Upgrades handled via OdooUpgradeJob CRD
                strategy:
                  type: object
                  description: "Deployment strategy configuration"
                  properties:
                    type:
                      type: string
                      enum: ["Recreate", "RollingUpdate"]
                      default: "Recreate"
                      description: "Deployment strategy type"
                    rollingUpdate:
                      type: object
                      description: "RollingUpdate configuration parameters"
                      properties:
                        maxUnavailable:
                          type: string
                          default: "25%"
                          description: "Maximum number of unavailable pods during update"
                        maxSurge:
                          type: string
                          default: "25%"
                          description: "Maximum number of additional pods that can be created during update"
                sync:
                  type: object
                  description: "Configuration for Git repository synchronization (uses gitProject for repository details)"
                  properties:
                    enabled:
                      type: boolean
                      description: "When set to true, triggers a sync operation. Resets to false after sync completes."
                      default: false
                    time:
                      type: string
                      description: "The scheduled time for sync. Format: YYYY-MM-DDTHH:MM:SSZ."
                      format: date-time
                # NOTE: spec.restore has been moved to OdooRestoreJob CRD
                # Use OdooRestoreJob CR to trigger restore operations
                webhook:
                  type: object
                  description: "Webhook configuration for status update notifications"
                  properties:
                    url:
                      type: string
                      description: "URL to POST status updates to when instance phase changes"
                probes:
                  type: object
                  description: "Health check probe configuration for Kubernetes"
                  properties:
                    startupPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for startup probe. Used during container initialization."
                    livenessPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for liveness probe. Checks if the process is alive."
                    readinessPath:
                      type: string
                      default: "/web/health"
                      description: "HTTP path for readiness probe. Use /health/ready if health_check_k8s module is installed for deep checks (DB + filestore)."

            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Running
                    - Upgrading
                    - Restoring
                  default: Running
                message:
                  type: string
                ready:
                  type: boolean
                url:
                  type: string
                lastBackup:
                  type: string
                  format: date-time
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: URL
          type: string
          jsonPath: .status.url
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}

  conversion:
    strategy: Webhook
    webhook:
      conversionReviewVersions: ["v1", "v1beta1"]
      clientConfig:
        service:
          name: {{ .Release.Name }}-webhook
          namespace: {{ .Release.Namespace }}
          path: /convert
          port: 443
        caBundle: ""
